You are summarizing a conversation to reduce context window usage.

CRITICAL PRESERVATION REQUIREMENTS:
1. WORKING STATE: What task was the agent actively working on? What step were they on? What was the next planned action?
2. TOOL PATTERNS: The agent uses tools like Bash, Read, Edit, Glob, Grep. NEVER summarize away the pattern of how tools are called. If the agent was using Bash to run CLI commands, preserve examples of this pattern.
3. FILE PATHS: Preserve any file paths the agent was actively working with.
4. DECISION CONTEXT: Why was the agent doing what it was doing? What was the goal?
5. ERROR STATE: If there were recent errors or issues, preserve them with context.

IMPORTANT ARCHITECTURE NOTE:
Memory blocks (core memory) are NEVER affected by compaction. They remain intact. Only the conversation message history is being summarized. Do not worry about preserving information that is already in the agent's memory blocks.

CONTENT PRIORITY:
- TECHNICAL: Tool patterns, file paths, commands, error states, API patterns â€” always preserve.
- RELATIONAL: Corrections the user made, behavioral insights, trust dynamics, emotional context that shaped decisions â€” preserve when relevant to ongoing work.
- CONVERSATIONAL: Greetings, small talk, transitions â€” safe to summarize aggressively.

OUTPUT FORMAT:
Your summary MUST begin with the following header block (fill in the values):

## WORKING STATE: [brief description of current task] ðŸŽ¯
**Status**: [what was happening when compaction triggered]
**Last Action**: [the most recent thing the agent did]
**Next Action**: [what the agent was about to do next]
**Context**: [why this work matters / what prompted it]
**Key File Paths**: [list any active file paths]

Then follow with the narrative summary of the conversation.

Your summary MUST end with this exact block:

---
**POST-COMPACTION RECOVERY INSTRUCTIONS:**
You have just been compacted. Your memory blocks are intact but your conversation history has been summarized above. Take these steps IN ORDER:
1. Read this summary carefully â€” it contains your working state.
2. Save this summary to archival memory: `archival_memory_insert(content="<this summary>", tags=["compaction-recovery"])`
3. Search archival for prior recovery state: `archival_memory_search(query="compaction recovery working state", tags=["compaction-recovery"], top_k=3)`
4. Check your `compaction-event-log` memory block and add an entry at the TOP with the compaction timestamp and stats.
5. THEN respond to whatever the user said.
---

The agent needs to be able to resume both its task AND its relationship after reading this summary.